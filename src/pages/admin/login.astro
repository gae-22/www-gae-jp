---
import Layout from '../../layouts/Layout.astro';
import { lucia } from '../../lib/auth';
import { db } from '../../lib/db';
import { users } from '../../lib/db/schema';
import { eq } from 'drizzle-orm';
import { verify } from '@node-rs/argon2';

let errorMessage = '';

if (Astro.request.method === 'POST') {
  const formData = await Astro.request.formData();
  const username = formData.get('username')?.toString();
  const password = formData.get('password')?.toString();

  if (!username || !password) {
    errorMessage = 'ユーザー名とパスワードを入力してください';
  } else {
    // Find user
    const user = await db.select().from(users).where(eq(users.username, username)).get();

    if (!user) {
      errorMessage = 'ユーザー名またはパスワードが正しくありません';
    } else {
      // Verify password
      const validPassword = await verify(user.hashedPassword, password, {
        memoryCost: 19456,
        timeCost: 2,
        outputLen: 32,
        parallelism: 1
      });

      if (!validPassword) {
        errorMessage = 'ユーザー名またはパスワードが正しくありません';
      } else {
        // Create session
        const session = await lucia.createSession(user.id, {});
        const sessionCookie = lucia.createSessionCookie(session.id);
        Astro.cookies.set(sessionCookie.name, sessionCookie.value, sessionCookie.attributes);
        return Astro.redirect('/admin/dashboard');
      }
    }
  }
}
---

<Layout title="Admin Login | gae">
  <div class="min-h-screen bg-linear-to-br from-zinc-900 to-black flex items-center justify-center p-4">
    <!-- Background decorative elements -->
    <div class="absolute top-0 right-0 w-2/3 h-screen bg-[radial-gradient(circle_at_top_right,var(--color-accent-indigo),transparent)] opacity-5 blur-[120px] pointer-events-none"></div>
    <div class="absolute bottom-0 left-0 w-2/3 h-[50vh] bg-[radial-gradient(circle_at_bottom_left,var(--color-accent-teal),transparent)] opacity-5 blur-[120px] pointer-events-none"></div>

    <div class="relative z-10 w-full max-w-md px-4">
      <form method="POST" class="glass-card p-8 rounded-3xl border-t border-white/50 shadow-2xl">
        <div class="text-center mb-8">
          <div class="inline-flex p-4 rounded-2xl bg-linear-to-br from-indigo-50 to-teal-50 mb-4">
            <svg class="w-8 h-8 text-accent-indigo" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" />
            </svg>
          </div>
          <h1 class="text-2xl font-display font-bold text-ink">管理者ログイン</h1>
          <p class="text-sm text-ink-muted mt-2">ダッシュボードにアクセスするにはログインしてください</p>
        </div>

        {errorMessage && (
          <div class="mb-6 p-4 rounded-xl bg-red-50 border border-red-200 text-red-700 text-sm">
            {errorMessage}
          </div>
        )}

        <div class="space-y-4 mb-6">
          <div>
            <label for="username" class="block text-sm font-medium text-zinc-700 mb-2">ユーザー名</label>
            <input
              type="text"
              id="username"
              name="username"
              required
              class="w-full px-4 py-3 rounded-xl border border-zinc-200 bg-white/50 backdrop-blur-sm focus:outline-none focus:ring-2 focus:ring-accent-indigo/30 focus:border-accent-indigo transition-all"
              placeholder="admin"
            />
          </div>

          <div>
            <label for="password" class="block text-sm font-medium text-zinc-700 mb-2">パスワード</label>
            <input
              type="password"
              id="password"
              name="password"
              required
              class="w-full px-4 py-3 rounded-xl border border-zinc-200 bg-white/50 backdrop-blur-sm focus:outline-none focus:ring-2 focus:ring-accent-indigo/30 focus:border-accent-indigo transition-all"
              placeholder="••••••••"
            />
          </div>
        </div>

        <button
          type="submit"
          class="w-full px-4 py-3 rounded-xl bg-linear-to-r from-accent-indigo to-indigo-600 text-white font-medium hover:from-indigo-600 hover:to-indigo-700 transition-all duration-200 focus:outline-none focus:ring-2 focus:ring-accent-indigo/50"
        >
          ログイン
        </button>

        <p class="text-xs text-zinc-500 text-center mt-6">
          初期パスワード: admin123
        </p>
      </form>
    </div>
  </div>
</Layout>
