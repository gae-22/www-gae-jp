---
import Layout from './Layout.astro';
import Header from '~/components/layout/Header.astro';
import Footer from '~/components/layout/Footer.astro';
import { Image } from 'astro:assets';
import type { CollectionEntry } from 'astro:content';

interface Props {
	post: CollectionEntry<'blog'>;
    headings: { depth: number; slug: string; text: string }[];
}

const { post, headings } = Astro.props;
const { title, description, publishedAt, cover, coverAlt } = post.data;
---

<Layout title={`${title} | gae`} description={description}>
    <div class="progress-bar fixed top-0 left-0 w-full h-0.5 bg-zinc-200/50 z-60">
        <div class="h-full bg-accent-indigo origin-left scale-x-0 transition-transform duration-100 ease-out" id="reading-progress"></div>
    </div>

    <Header />

    <article class="min-h-screen">
        <!-- Immersive Header -->
        <div class="relative h-[70vh] md:h-[85vh] w-full flex items-center justify-center overflow-hidden">
            <!-- Background Image (Blurred) -->
            <div class="absolute inset-0 z-0">
                {cover ? (
                    <Image src={cover} alt={coverAlt || ""} class="w-full h-full object-cover blur-3xl opacity-40 scale-110" />
                ) : (
                    <div class="w-full h-full bg-linear-to-br from-indigo-950/80 via-black to-black"></div>
                )}
                <div class="absolute inset-0 bg-deep/40"></div>
                <!-- Subtle noise overlay -->
                <div class="absolute inset-0 opacity-[0.03] pointer-events-none mix-blend-overlay bg-[url('/noise.png')]"></div>
            </div>

            <!-- Content Overlay -->
            <div class="relative z-10 text-center px-4 max-w-5xl mx-auto space-y-8 animate-slide-up">
                <div class="flex items-center justify-center gap-4 text-xs text-neon-cyan font-mono uppercase tracking-[0.3em]">
                    <span class="w-8 h-px bg-neon-cyan/30"></span>
                    <time datetime={publishedAt.toISOString()}>
                        {publishedAt.toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}
                    </time>
                    <span class="w-8 h-px bg-neon-cyan/30"></span>
                </div>

                <h1 class="text-3xl sm:text-5xl md:text-7xl lg:text-8xl font-display font-medium leading-[1.1] text-white tracking-tight drop-shadow-md text-balance">
                    {title}
                </h1>

                {post.data.tags.length > 0 && (
                    <div class="flex flex-wrap justify-center gap-3">
                        {post.data.tags.map(tag => (
                            <span class="px-4 py-1.5 rounded-full border border-white/20 bg-white/10 text-[10px] font-mono font-bold text-zinc-200 backdrop-blur-md uppercase tracking-wider hover:bg-white/20 transition-colors">
                                {tag}
                            </span>
                        ))}
                    </div>
                )}
            </div>

            <!-- Scroll Indicator -->
            <div class="absolute bottom-10 left-1/2 -translate-x-1/2 animate-bounce opacity-30">
                <div class="w-px h-12 bg-linear-to-b from-white to-transparent"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="relative z-20 bg-paper/80 backdrop-blur-3xl border-t border-zinc-200">
            <div class="max-w-7xl mx-auto px-4 py-16 lg:py-24 grid grid-cols-1 lg:grid-cols-12 gap-16">

                <!-- Sidebar (TOC) -->
                <aside class="hidden lg:block lg:col-span-3 lg:col-start-1">
                    <div class="sticky top-32 space-y-8">
                        <div class="glass-card rounded-2xl p-8 border-zinc-200">
                            <h4 class="text-[10px] font-mono text-ink-muted uppercase tracking-[0.2em] mb-6 opacity-60">Table of Contents</h4>
                            <ul class="space-y-4 text-sm text-ink-muted font-light">
                                {headings.filter(h => h.depth <= 3).map((heading, index) => (
                                    <li class:list={[
                                        "transition-all duration-300",
                                        index === 0 ? "text-accent-teal font-medium flex items-center gap-2" : "hover:text-ink cursor-pointer"
                                    ]}>
                                        {index === 0 && (
                                            <span class="w-1.5 h-1.5 rounded-full bg-accent-teal shadow-[0_0_8px_rgba(15,118,110,0.3)]"></span>
                                        )}
                                        <a href={`#${heading.slug}`} class:list={[
                                            heading.depth === 3 ? "pl-4 text-xs" : ""
                                        ]}>
                                            {heading.text}
                                        </a>
                                    </li>
                                ))}
                                {headings.length === 0 && (
                                    <li class="italic opacity-50 text-xs text-ink-muted">No headings found</li>
                                )}
                            </ul>
                        </div>
                    </div>
                </aside>

                <!-- Prose Content -->
                <div class="col-span-1 lg:col-span-7 lg:col-start-5 prose prose-slate prose-xl max-w-none
                    prose-headings:text-ink prose-headings:font-display prose-headings:font-bold prose-headings:tracking-tight
                    prose-h2:text-4xl prose-h2:mt-16 prose-h2:mb-8 prose-h2:border-b prose-h2:border-zinc-200 prose-h2:pb-4 prose-h2:scroll-mt-44
                    prose-h3:text-2xl prose-h3:mt-10 prose-h3:mb-6 prose-h3:scroll-mt-44
                    prose-p:text-ink-muted prose-p:leading-relaxed prose-p:font-light prose-p:mb-8 prose-p:text-balance
                    prose-a:text-accent-indigo prose-a:no-underline prose-a:border-b prose-a:border-accent-indigo/20 hover:prose-a:border-accent-indigo transition-colors
                    prose-strong:text-ink prose-strong:font-bold
                    prose-blockquote:border-l-accent-teal prose-blockquote:bg-zinc-50 prose-blockquote:py-4 prose-blockquote:px-8 prose-blockquote:rounded-r-2xl prose-blockquote:italic prose-blockquote:text-ink-muted
                    prose-ul:list-disc prose-ul:pl-8 prose-li:text-ink-muted prose-li:mb-3
                    prose-code:text-accent-indigo prose-code:bg-zinc-100 prose-code:border prose-code:border-zinc-200 prose-code:px-1.5 prose-code:py-0.5 prose-code:rounded-md prose-code:before:content-none prose-code:after:content-none
                    prose-pre:bg-transparent! prose-pre:m-0! prose-pre:p-0! prose-pre:shadow-none! prose-pre:rounded-none!
                    prose-img:rounded-4xl prose-img:shadow-xl prose-img:border prose-img:border-zinc-200">
                    <slot />
                </div>

            </div>
        </div>
    </article>

    <Footer />

    <script>
        // Reading Progress Script
        const progressBar = document.getElementById('reading-progress');
        window.addEventListener('scroll', () => {
            const scrollTop = window.scrollY;
            const docHeight = document.documentElement.scrollHeight - window.innerHeight;
            const scrollPercent = scrollTop / docHeight;
            if (progressBar) {
                progressBar.style.transform = `scaleX(${scrollPercent})`;
            }
        });
    </script>
</Layout>
